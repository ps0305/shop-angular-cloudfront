version: 0.2

env:
  variables:
    SOURCE_OUTPUT_BUCKET: "/preprod/cicd/source-artifact/bucket"
    SOURCE_PATH: "source"
    APP_NAME: "shop"
    TARGET_BRANCH: "develop"

phases:
  install:
    runtime-versions:
      nodejs: 14

  build:
    commands:
      # Debug: List the current directory permissions
      - echo "Listing current directory files and permissions:"
      - ls -la

      # Debug: Print environment variables
      - echo "CODEBUILD_WEBHOOK_TRIGGER=$CODEBUILD_WEBHOOK_TRIGGER"
      - echo "CODEBUILD_RESOLVED_SOURCE_VERSION=$CODEBUILD_RESOLVED_SOURCE_VERSION"
      - echo "CODEBUILD_SOURCE_REPO_URL=$CODEBUILD_SOURCE_REPO_URL"

      # Remove system package update for now to isolate the issue
      #- sudo apt-get update -y -q

      # Install dependencies with --unsafe-perm flag
      - npm install --no-progress --unsafe-perm

      # Extract source branch from CODEBUILD_WEBHOOK_TRIGGER
      - SOURCE_BRANCH=$(echo $CODEBUILD_WEBHOOK_TRIGGER | awk '{split($0, a,"/"); print a[2]}')
      - echo "Extracted source branch: $SOURCE_BRANCH"

      # Clean-up workspace
      - rm -rf ./node_modules ./dist

      # Check if 'zip' is available
      - which zip || sudo apt-get install zip -y

      # Archive workspace
      - zip -qr source.zip .

      # Check if aws-cli is available
      - which aws || pip install awscli

      # Upload workspace archive to S3, using environment variables
      - aws s3 cp source.zip s3://${SOURCE_OUTPUT_BUCKET}/${SOURCE_PATH}/${APP_NAME}/${APP_NAME}.zip --metadata CommitID="${CODEBUILD_RESOLVED_SOURCE_VERSION}",BranchName="${SOURCE_BRANCH}",RepoURL="${CODEBUILD_SOURCE_REPO_URL}"
